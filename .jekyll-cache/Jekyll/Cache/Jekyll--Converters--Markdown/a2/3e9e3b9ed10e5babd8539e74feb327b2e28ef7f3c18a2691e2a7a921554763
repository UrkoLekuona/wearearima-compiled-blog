I"Ø<p>Despu√©s de la ‚Äúmuerte‚Äù de Spring Batch Admin, toda la funcionalidad que nos ofrec√≠a se ha movido a <a href="https://dataflow.spring.io/">Spring Cloud Data Flow</a>.</p>

<p>Pero Spring Cloud Data Flow es un sistema m√°s complejo y con m√°s opciones a parte de lo puramente batch.</p>

<p>¬øC√≥mo hacemos para instalar lo m√≠nimo necesario para utilizarlo como sistema de gesti√≥n de nuestros jobs?</p>

<p>Vamos a ver primero qu√© es SCDF y los diferentes componentes que necesita para funcionar.</p>

<p>Por suerte, toda la parte de streaming del sistema se puede deshabilitar mediante propiedades de configuraci√≥n. Con esto, nos evitamos tener que instalar Skipper.</p>

<p>Adem√°s, toda la parte de monitorizaci√≥n utilizando Prometheus y Grafana tambi√©n nos la podemos quitar, ya que est√° m√°s pensada para monitorizar temas de streaming.</p>

<p>Con todo esto, para una instalaci√≥n en Kubernetes y tomando como ejemplo la gu√≠a de instalaci√≥n oficial, los pasos a seguir ser√≠an los siguientes:</p>

<h2 id="descargar-el-proyecto">Descargar el proyecto</h2>
<p>Para instalar utilizando kubectl necesitamos descargarnos los ficheros de configuraci√≥n para Kubernetes del repositorio oficial.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://github.com/spring-cloud/spring-cloud-dataflow
cd spring-cloud-dataflow
git checkout v2.1.2.RELEASE
</code></pre></div></div>

<h2 id="escoger-un-sistema-de-colas-de-mensajes">Escoger un sistema de colas de mensajes</h2>
<p>Si queremos instalar RabbitMQ:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create -f src/kubernetes/rabbitmq/
</code></pre></div></div>

<p>Si por el contrario queremos utilizar Kafka:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create -f src/kubernetes/kafka/
</code></pre></div></div>

<h2 id="desplegar-mysql">Desplegar MySQL</h2>
<p>El proyecto que nos hemos descargado ya tiene los ficheros de configuraci√≥n necesarios para desplegar una base de datos MySQL y configurar lo necesario:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create -f src/kubernetes/mysql/
</code></pre></div></div>

<h2 id="quitar-la-configuraci√≥n-de-prometheus-y-grafana">Quitar la configuraci√≥n de Prometheus y Grafana</h2>
<p>Para que el servidor no falle al arrancar, debemos quitar la configuraci√≥n de Prometheus y Grafana que se encuentra en el fichero src/kubernetes/server/server-config.yaml. La secci√≥n que debemos eliminar es la siguiente:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>applicationProperties:
  stream:
    management:
      metrics:
        export:
          prometheus:
            enabled: true
      endpoints:
        web:
          exposure:
            include: 'prometheus,info,health'
    spring:
      cloud:
        streamapp:
          security:
            enabled: false
grafana-info:
  url: 'https://grafana:3000'
</code></pre></div></div>

<h2 id="crear-los-roles-y-el-service-account">Crear los roles y el service account</h2>
<p>Para crear los roles necesarios y asociarlos debemos ejecutar los siguientes comandos:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create -f src/kubernetes/server/server-roles.yaml
kubectl create -f src/kubernetes/server/server-rolebinding.yaml
kubectl create -f src/kubernetes/server/service-account.yaml
</code></pre></div></div>

<h2 id="desactivar-la-opci√≥n-de-streaming-de-scdf">Desactivar la opci√≥n de streaming de SCDF</h2>
<p>Para desactivar todo lo relacionado con las tareas de streaming de SCDF tenemos que a√±adir una propiedad en uno de los ficheros de configuraci√≥n del servidor.</p>

<p>El fichero a modificar es src/kubernetes/server/server-deployment.yaml y tenemos que a√±adir lo siguiente en la secci√≥n env:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- name: SPRING_CLOUD_DATAFLOW_FEATURES_STREAMS_ENABLED
         value: 'false'
</code></pre></div></div>

<h2 id="desplegar-scdf-server">Desplegar SCDF server</h2>
<p>Con todo esto s√≥lo nos queda desplegar el servidor de SCDF, para esto, ejecutamos los siguientes comandos:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create -f src/kubernetes/server/server-config.yaml
kubectl create -f src/kubernetes/server/server-svc.yaml
kubectl create -f src/kubernetes/server/server-deployment.yaml
</code></pre></div></div>

<p>Para ver la ip asignada y poder entrar al dashboard ejecutamos el comando</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get svc scdf-server
</code></pre></div></div>

<p>El valor indicado en EXTERNAL-IP es el que tenemos que utilizar.</p>

<p>Si est√°s probando a instalarlo usando Minikube, el EXTERNAL-IP lo ver√°s como pending ya que no soporta LoadBalancer. Para saber la URL que tienes que utilizar para conectarte al servidor utiliza el comando siguiente:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>minikube service --url scdf-server
</code></pre></div></div>
:ET